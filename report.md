# Отчет о выполнении проекта Simple Docker (DO5)


- [Отчет о выполнении проекта Simple Docker (DO5)](#отчет-о-выполнении-проекта-simple-docker-do5)
  - [Part 1. Готовый докер](#part-1-готовый-докер)
  - [Part 2. Операции с контейнером](#part-2-операции-с-контейнером)
  - [Part 3. Мини веб-сервер](#part-3-мини-веб-сервер)
  - [Part 4. Свой докер](#part-4-свой-докер)
  - [Part 5. Dockle](#part-5-dockle)
  - [Part 6. Базовый Docker Compose](#part-6-базовый-docker-compose)

## Part 1. Готовый докер

- ***Проверка установки docker*** \
![Проверка установки docker](./images/t1_1.png)

- ***Скачиваем образ nginx*** \
![Скачиваем образ nginx](./images/t1_2.png)

В данном случае скачивается образ с тегом latest.

- ***Проверяем наличие скачанного образа nginx*** \
![Проверяем наличие скачанного образа nginx](./images/t1_3.png)

- ***Запускаем образ nginx (по id образа) и проверка запуска процесса*** \
![Запуск образа nginx](./images/t1_4.png)

- ***Вывод docker inspect*** \
![Конфигурация nginx 1](./images/t1_5.png) \
![Конфигурация nginx 2](./images/t1_6.png) \
![Конфигурация nginx 3](./images/t1_7.png) \
![Конфигурация nginx 4](./images/t1_8.png) \
![Конфигурация nginx 5](./images/t1_9.png)

Размер образа составляет 187 MB \
Замапленые порты 80/tcp \
IP адрес 172.17.0.2

- ***Останавливаем работку контейнера nginx (по id образа) и проверка остановки*** \
![Остановка контейнера nginx](./images/t1_10.png)

- ***Запускаем контенер nginx с мапингом на портыы 80 и 443*** \
![Запуск nginx](./images/t1_11.png)

- ***Проверяем доступность nginx по порту 80*** \
![Остановка контейнера nginx](./images/t1_12.png) \
Ввиду запуска контенера на WSL доступ осществляется по ip-адресу виртуальной машины.

- ***Перезапускаем контейнер и проверяем, что он перезапустился*** \
![Остановка контейнера nginx](./images/t1_13.png)

## Part 2. Операции с контейнером

- ***Заходим внутрь исполняющегося контейнера*** \
![Заходим внутрь контейнера](./images/t2_1.png)

- ***Читаем содержимое nginx.conf в контейнере*** \
![Читаем nginx.conf](./images/t2_2.png)

- ***Для изменения файла копируем его на хост*** \
![Копируем на хост nginx.conf](./images/t2_3.png)

- ***После изменения копируем файл в контейнер*** \
![Копируем в контенер измененный nginx.conf](./images/t2_4.png)

- ***Измененный файл (добавлен путь /status) имеет следующий вид (считано в контейнере)*** \
![Текст nginx.conf в контейнере](./images/t2_5.png) \
![Текст nginx.conf в контейнере (продолжение)](./images/t2_6.png) \
Измененный файл в проекте [nginx.conf](./nginx.conf)

- ***Так как nginx считывает конфигурацию оди раз при его запуске, перезапустим его что-бы применить сделанные настройки (выполняется внутри кнтейнера)*** \
![Перезапуск nginx](./images/t2_7.png)

- ***Проверяем, что все работает корректно*** \
![Проверка работоспособности](./images/t2_8.png)

- ***Экспортируем контейнер*** \
![Экспорт контейнера в файл](./images/t2_9.png)

- ***Останавливаем работу контейнера*** \
![Останавливаем работу контейнера](./images/t2_10.png)

- ***Удаляем образ nginx*** \
![Удаление образа](./images/t2_11.png) \
Так как образ используется контейнером удаление прозводим с с ключом -f, который позволяет удалить образ принудительно. При этом убеждаемся что остановленный контейнер на месте. \
![Проверка наличия контейнера](./images/t2_12.png)

- ***Удаляем контейнер*** \
![Проверка наличия контейнера](./images/t2_13.png)

- ***Импортируем образ контейнера*** \
![Проверка наличия контейнера](./images/t2_14.png) \
Следует помнить, что команда **docker export** переносит только файловую структуру контейнера и не переносит настроенные переменные среды и запуска. В этой связи необходимо команду запуска прописывать при создании и запуске контейнера.

- ***Запускаем контейнер*** \
![Запуск контейнера](./images/t2_15.png) \
параметры запуска можно подсмотреть выводе команды **docker inspect**, что выполнялся ранее.

- ***Проверяем работу*** \
![Запуск контейнера](./images/t2_16.png)

*Проверить выполнение задания можно с помощью файла контейнера [container.tar](./container.tar)*


## Part 3. Мини веб-сервер

- ***Для начала создадим простое приложение FastCGI.  [fcgi_app.c](./fcgi-app.c)***

- ***Установим библиотеки необходимые для создания web-сервера*** \
![Установка библиотек в систему](./images/t3_1.png)

- ***Собираем приложение.*** \
![Компиляция сервера](./images/t3_2.png) \
*Укажем место хранения заголовочного файла (параметр -I) и расположение файла библиотеки (параметр -L).*

- ***Создаем новый контейнер*** \
При создании контейнера определяем маппинг порта 81 на котором булем взаимодействовать с веб сервером и приложением. \
![Создаем новый контейнер](./images/t3_3.png)

- ***Проверяем работает ли контейнер*** \
![Проверка работы](./images/t3_4.png)

- ***Копируем файл настроек nginx для FastCGI приложения*** \
![Проверка работы](./images/t3_5.png) \
Файл настроек. [nginx.conf](./nginx-1.conf)

- ***Копируем исходный код FastCGI приложения*** \
![Проверка работы](./images/t3_6.png) 

- ***Обновляем содержимое списков репозитория*** \
![Проверка работы](./images/t3_7.png) \
Необходимо что бы получить список обновленных версий приложений и утилит необходимых для установки.

- ***Устанавливаем необходимые компоненты*** \
![Проверка работы](./images/t3_8.png) \
На данном этапе устанавливается: \
компилятор gcc, необходимый для сборки приложения \
библиотека libfcgi-dev (без нее приложение не скомпилируется) \
утилита spawn-fcgi

- ***Компилируем приложение*** \
![Проверка работы](./images/t3_9.png)

- ***Запускаем приложение как удаленное с прослушиванием необходимого порта*** \
![Проверка работы](./images/t3_10.png) \
параметр -p отвечает за назначение порта прослушивателя. Согласно заданию мы "вешаем" приложение на порт 8080.
Использование spawn-fcgi позволяет нам разместить приложение как на локальном, так и на удаленном сервере. При необходимости обновления и перезапуска приложение и nginx могут перезапускатьс отдельно друг от друга, т.е. перезапуск nginx при перезапуске приложения не потребуется.

- ***Рестартуем nginx*** \
![Проверка работы](./images/t3_11.png) \
Необходимый шаг, что бы новые настройки из ранее скопированного файла вступили в силу. Прилоежение fcgi рестартовать при этом не требуется.

- ***Проверка результатов*** \
В консоли \
![Проверка работы](./images/t3_12.png) \
\
В браузере \
![Проверка работы](./images/t3_13.png)

Для проверки можно воспользоваться скриптом автоматизации [task3.sh](./task3.sh). (Запуск из под sudo)

## Part 4. Свой докер

- ***Создаем DOCKERFILE***
Данный файл содержит последовательность инструкций выполняя которые он собирает образ для последующего использования. [Dockerfile](./Dockerfile1)

Для исходника используем образ nginx (тег latest). \
**FROM nginx:latest**

Копируем в образ файлы настроек, исходник приложения, скрипт старта вебсервера и запуска вебприложения (используется при старте контейнера). \
**COPY ./nginx-1.conf /etc/nginx/nginx.conf** \
**COPY ./fcgi-app.c /etc/nginx/fcgi-app.c** \
**COPY ./t4init.sh /etc/nginx/init.sh**

Выполняем процедуру установки необходимых компонент для компиляции приложения, spawn-fcgi, библиотеку libfcgi-dev; компилируем программу и изменяем режим исполнения файла инициализирующего скрипта
**RUN apt-get update &&**  \
    **apt-get install -y gcc spawn-fcgi libfcgi-dev &&** \ 
    **gcc /etc/nginx/fcgi-app.c -o /etc/nginx/webserver -l fcgi &&** \
    **chmod +x /etc/nginx/init.sh** \
Команда RUN выполняется 1 раз при сборке контейнера.

Задаем инициализирующий скрипт как точку входа по умолчанию. \
**ENTRYPOINT [ "/etc/nginx/init.sh" ]** \
Данный скрипт будет отрабатывать при каждом запуске контейнера.

- ***Собираем Dockerfile*** \
![Проверка работы](./images/t4_1.png) \
Если не указывать тег, то автоматически будет присвоен latest.

- ***Проверяем наличие собранного образа*** \
![Проверка работы](./images/t4_2.png) \
В случае ошибок на этапе сборки образ не появится в списке.

- ***Запускаем контейнер на основе нового образа*** \
![Проверка работы](./images/t4_3.png) \
Если все корректно, то в выводе docker ps отобразится запущенный контейнер

- ***Проверка корректности настройки*** \
![Проверка работы](./images/t4_4.png)

- ***Возврат страницы статуса*** \
![Проверка работы](./images/t4_5.png)

## Part 5. Dockle

- ***Установка Dockle*** \
![Проверка работы](./images/t5_1.png)

- ***Сканируем образ в Dockle*** \
![Проверка работы](./images/t5_2.png) \
![Проверка работы](./images/t5_3.png)

- ***Дополняем DOCKERFILE. [Dockerfile](./Dockerfile)***

- ***Вывод Dockle после исправления*** \
![Проверка работы](./images/t5_4.png)


## Part 6. Базовый Docker Compose

- ***Создаем файл docker-compose.yml. [docker-compose.yml](./docker-compose.yml)***

- ***Создаем конфигурационный файл для nginx-proxy. [nginx.conf](./nginx-2.conf)***

- ***Запускаем сборку проекта***
![Проверка работы](./images/t6_1.png)


- ***Проверяем выполнение***
![Проверка работы](./images/t6_2.png) \
![Проверка работы](./images/t6_3.png) \
![Проверка работы](./images/t6_4.png)